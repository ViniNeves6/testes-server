{% extends "base_authenticated.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

{% endblock %}

{% block content %}
<style>
    body {
        padding-top: 0px !important;
    }
</style>
<div class="d-flex flex-column w-100 pt-0 gap-2 align-items-between justify-content-start pe-1 adjust-side-menu"
    style="min-height: 100vh;">
    <div class="list-group w-100 border-0 rounded-0" fill="currentColor">
        <p class="fs-3 fw-bold my-0 py-2 ps-3 text-white bg-body-tertiary">Histórico de atividades</p>
        <div class="list-group-item cor-preto1">
            <div id="datePicker">
                <div>
                    <input type="date" id="start-date" min="{{dates[0]}}" max="{{dates[-1]}}" value="{{dates[0]}}">
                    <input type="date" id="end-date" min="{{dates[0]}}" max="{{dates[-1]}}" value="{{dates[-1]}}">
                </div>
                <div id="output-date-range"></div>
            </div>
            <div id="graph-line" style="margin-left: 5vh;"></div>

            <script>
                // Dados de exemplo
                const datas = JSON.parse('{{ dates | tojson | safe }}');
                const valores = JSON.parse('{{ values | tojson | safe}}');

                // Crie um objeto similar a um DataFrame
                const df = {
                    Data: datas,
                    Valor: valores
                };

                // Intervalo de datas iniciai
                const data_inicial = datas[0];
                const data_final = datas[datas.length - 1];

                // Crie o gráfico inicial
                atualizarGrafico(data_inicial, data_final);

                // Adicione um ouvinte de eventos aos campos de data
                const inputDataInicial = document.getElementById('start-date');
                const inputDataFinal = document.getElementById('end-date');

                inputDataInicial.addEventListener('input', function () {
                    const data_inicial = inputDataInicial.value;
                    const data_final = inputDataFinal.value;
                    atualizarGrafico(data_inicial, data_final);
                });

                inputDataFinal.addEventListener('input', function () {
                    const data_inicial = inputDataInicial.value;
                    const data_final = inputDataFinal.value;
                    atualizarGrafico(data_inicial, data_final);
                });

                function atualizarGrafico(data_inicial, data_final) {

                    // Filtrar os dados com base no intervalo de datas selecionado
                    const dadosFiltradosISO = df.Data.filter(function (data) {
                        return data >= data_inicial && data <= data_final;
                    });

                    // Converte datas ISO 8601 para formato DD/MM/YYYY
                    const dadosFiltrados = dadosFiltradosISO.map(date => {
                        const [year, month, day] = date.split('-');
                        return `${day}/${month}/${year}`;
                    });

                    const valoresFiltrados = df.Valor.filter(function (data, index) {
                        return df.Data[index] >= data_inicial && df.Data[index] <= data_final;
                    });

                    // Atualize o gráfico com os dados filtrados
                    const trace = {
                        x: dadosFiltrados,
                        y: valoresFiltrados,
                        type: 'bar',
                        textposition: 'inside',
                        marker: {
                            color: 'rgb(252, 126, 23)',
                            line: {
                                width: 0.1
                            }
                        },
                    };

                    const layout = {
                        xaxis: {
                            title: 'Data',
                            showline: true,
                            tickmode: 'auto',
                            linecolor: '#969696',
                            showgrid: true,
                            gridcolor: 'rgba(0,0,0,0)',
                            mirror: true,
                            tickformat: "%d/%m/%Y",
                            dtick: 30 * 24 * 60 * 60 * 1000,
                            tickvals: dadosFiltrados,
                            //tickangle:-90, 
                            tickfont: {
                                size: 10
                            },
                            tickformatstops: [{
                                "dtickrange": [null, 1000],
                                "value": "%H:%M:%S.%L ms"
                            },
                            {
                                "dtickrange": [1000, 60000],
                                "value": "%H:%M:%S s"
                            },
                            {
                                "dtickrange": [60000, 3600000],
                                "value": "%H:%M m"
                            },
                            {
                                "dtickrange": [3600000, 86400000],
                                "value": "%e. %b %Y"
                            },
                            {
                                "dtickrange": [86400000, 604800000],
                                "value": "%e. %b %Y"
                            },
                            {
                                "dtickrange": [604800000, "M1"],
                                "value": "%e. %b %Y"
                            },
                            {
                                "dtickrange": ["M1", "M1"],
                                "value": "%b '%y M"
                            },
                            {
                                "dtickrange": ["M2", 'M24'],
                                "value": "%Y"
                            }
                            ]

                        },
                        yaxis: {
                            title: 'Coletas',
                            tickmode: 'array',
                            range: [0, Math.max(...valoresFiltrados) + 1],
                            showline: true,
                            linecolor: 'rgb(150, 150, 150)',
                            gridcolor: 'rgba(150, 150, 150,0.1)',
                            mirror: true,
                            showgrid: true,
                            gridwidth: 1,
                            dtick: 1,
                        },
                        barmode: 'group',
                        bargap: 0.1,
                        paper_bgcolor: 'rgba(0,0,0,0)',
                        plot_bgcolor: 'rgba(0,0,0,0)',
                        font: { color: '#969696' },
                        template: 'simple_white',
                    };

                    Plotly.newPlot('graph-line', [trace], layout);
                }
            </script>


        </div>
    </div>

    <div class="list-group flex-lg-column">
        <p class="fs-4 fw-semibold my-0 py-1 ps-3 text-white bg-body-tertiary">Últimas coletas</p>
        {% for item in data %}
        <form action="{{ url_for('index_bp.index_post') }}" method="POST">
            <a href="javascript:;" onclick="parentNode.submit();"
                class="list-group-item align-items-center list-group-item-action d-flex gap-3 py-3 cor-preto1"
                aria-current="true">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor"
                    class="bi bi-calendar3" viewBox="0 0 16 16">
                    <path
                        d="M14 0H2a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zM1 3.857C1 3.384 1.448 3 2 3h12c.552 0 1 .384 1 .857v10.286c0 .473-.448.857-1 .857H2c-.552 0-1-.384-1-.857V3.857z" />
                    <path
                        d="M6.5 7a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm-9 3a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z" />
                </svg>
                <div class="d-flex gap-2 w-100 justify-content-between">
                    <div>
                        <h6 class="mb-1">Dia: {{ item["date"] }}</h6>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                            class="bi me-2 bi-clock-history" viewBox="0 0 16 16">
                            <path
                                d="M8.515 1.019A7 7 0 0 0 8 1V0a8 8 0 0 1 .589.022l-.074.997zm2.004.45a7.003 7.003 0 0 0-.985-.299l.219-.976c.383.086.76.2 1.126.342l-.36.933zm1.37.71a7.01 7.01 0 0 0-.439-.27l.493-.87a8.025 8.025 0 0 1 .979.654l-.615.789a6.996 6.996 0 0 0-.418-.302zm1.834 1.79a6.99 6.99 0 0 0-.653-.796l.724-.69c.27.285.52.59.747.91l-.818.576zm.744 1.352a7.08 7.08 0 0 0-.214-.468l.893-.45a7.976 7.976 0 0 1 .45 1.088l-.95.313a7.023 7.023 0 0 0-.179-.483zm.53 2.507a6.991 6.991 0 0 0-.1-1.025l.985-.17c.067.386.106.778.116 1.17l-1 .025zm-.131 1.538c.033-.17.06-.339.081-.51l.993.123a7.957 7.957 0 0 1-.23 1.155l-.964-.267c.046-.165.086-.332.12-.501zm-.952 2.379c.184-.29.346-.594.486-.908l.914.405c-.16.36-.345.706-.555 1.038l-.845-.535zm-.964 1.205c.122-.122.239-.248.35-.378l.758.653a8.073 8.073 0 0 1-.401.432l-.707-.707z" />
                            <path d="M8 1a7 7 0 1 0 4.95 11.95l.707.707A8.001 8.001 0 1 1 8 0v1z" />
                            <path
                                d="M7.5 3a.5.5 0 0 1 .5.5v5.21l3.248 1.856a.5.5 0 0 1-.496.868l-3.5-2A.5.5 0 0 1 7 9V3.5a.5.5 0 0 1 .5-.5z" />
                        </svg><span class="mb-0 opacity-75">Às {{ item["time"] }}</span>
                    </div>
                    <div>
                        <h6 class="mb-2 w-100 text-white" style="text-align: end;">Páginas coletadas</h6>
                        {% for site in item["sites"] %}
                        <small
                            class="text-bg-light opacity-100 text-nowrap border px-2 py-1 ms-1 rounded-pill custom-style"
                            style="color: #fd7e14;">{{ site }}</small>
                        {% endfor %}
                    </div>
                </div>
                <input type="hidden" name="dataid" value="{{ item['id'] }}">
            </a>
        </form>
        {% endfor %}
    </div>
</div>

{% endblock %}